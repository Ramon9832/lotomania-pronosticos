<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Lotomania PRO â€“ ConexiÃ³n Directa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body{font-family:'Segoe UI',sans-serif;background:#e8ecef;padding:20px;color:#2c3e50}
    .container{max-width:900px;margin:auto}
    .box{background:#fff;padding:20px;border-radius:15px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,0.1);text-align:center}
    h1{color:#1b5e20;margin-top:0}
    .status-panel{display:flex;justify-content:space-around;margin-bottom:15px;font-size:14px;font-weight:bold}
    .badge{padding:5px 15px;border-radius:20px;color:#fff}
    .online{background:#2e7d32} .offline{background:#d32f2f}
    button{background:#1b5e20;color:#fff;border:none;padding:15px 30px;font-size:16px;border-radius:8px;cursor:pointer;font-weight:bold;width:100%;max-width:400px;transition:0.3s}
    button:hover{background:#2e7d32;transform:scale(1.02)}
    .game-box{background:#fff;padding:15px;border-radius:10px;margin-top:15px;border-left:6px solid #1b5e20;text-align:left;position:relative}
    .mirror-box{background:#f1f8e9;border-left:6px solid #8bc34a;margin-top:5px;font-size:13px}
    .num-grid{display:flex;flex-wrap:wrap;gap:4px;margin-top:10px}
    .n{background:#e0e0e0;padding:2px 5px;border-radius:3px;font-size:12px;font-family:monospace}
    .label-espejo{color:#558b2f;font-weight:bold;font-size:11px;text-transform:uppercase}
</style>
</head>
<body>

<div class="container">
    <div class="box">
        <h1>ðŸŽ¯ Lotomania PRO: Inteligencia de Datos</h1>
        <div class="status-panel">
            <div id="st-db" class="badge offline">DB: Desconectada</div>
            <div id="st-info">Sorteos: 0</div>
        </div>
        <select id="cantidad" style="padding:10px;width:200px;border-radius:5px;margin-bottom:15px">
            <option value="5">5 Jugadas + Espejo</option>
            <option value="10">10 Jugadas + Espejo</option>
            <option value="20">20 Jugadas + Espejo</option>
        </select><br>
        <button onclick="procesarSistema()">âš¡ GENERAR PRONÃ“STICO MAESTRO</button>
    </div>

    <div id="panel-resultados"></div>
</div>

<script>
// ID de tu hoja proporcionado
const SHEET_ID = "1NOSXFL_Yzfqy6My8tZSh0Trb1saheQGzHNVpcpVXzoE";
// URL de VisualizaciÃ³n de Google (MÃ¡s estable que el CSV directo)
const QUERY_URL = https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv;

let frecuencias = {};
let jugadasActuales = [];

async function cargarDatos() {
    const stDB = document.getElementById("st-db");
    try {
        const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(QUERY_URL);
        const res = await fetch(proxyUrl);
        const text = await res.text();
        
        const filas = text.split("\n").slice(1); // Saltar encabezado
        filas.forEach(f => {
            const c = f.split(",");
            if(c[2]) {
                const nums = c[2].replace(/"/g, "").split(" ");
                nums.forEach(n => {
                    let num = n.padStart(2, "0");
                    frecuencias[num] = (frecuencias[num] || 0) + 1;
                });
            }
        });
        
        stDB.textContent = "DB: Conectada";
        stDB.className = "badge online";
        document.getElementById("st-info").textContent = "Sorteos analizados: " + filas.length;
        return true;
    } catch (e) {
        stDB.textContent = "DB: Modo Local";
        stDB.className = "badge offline";
        console.warn("Falla de conexiÃ³n, usando motor aleatorio balanceado.");
        return false;
    }
}

function validarFiltros(nums) {
    // 1. Balance Par/Impar
    let pares = nums.filter(n => parseInt(n) % 2 === 0).length;
    if (pares < 23 || pares > 27) return false;

    // 2. Filtro de Cuadrantes (MÃ­nimo 10 por cuadrante)
    let cuadrantes = [0,0,0,0];
    nums.forEach(n => {
        let v = parseInt(n), f = Math.floor(v/10), c = v%10;
        if(f<5 && c<5) cuadrantes[0]++; else if(f<5 && c>=5) cuadrantes[1]++;
        else if(f>=5 && c<5) cuadrantes[2]++; else cuadrantes[3]++;
    });
    if(cuadrantes.some(q => q < 9)) return false;

    return true;
}

async function procesarSistema() {
    await cargarDatos();
    const cant = parseInt(document.getElementById("cantidad").value);
    const panel = document.getElementById("panel-resultados");
    panel.innerHTML = "ðŸŒ€ Ejecutando algoritmos de filtrado...";

    // Tu Regla: 8 por decena (NÃºcleo sÃ³lido central)
    let nucleo80 = [];
    for(let d=0; d<10; d++) {
        for(let n=2; n<=9; n++) nucleo80.push((d*10 + n).toString().padStart(2,"0"));
    }

    // Elegir los 5 mejores de los 20 restantes (terminados en 0 y 1)
    let restantes = [];
    for(let i=0; i<100; i++) {
        let s = i.toString().padStart(2,"0");
        if(!nucleo80.includes(s)) restantes.push(s);
    }
    restantes.sort((a,b) => (frecuencias[b]||0) - (frecuencias[a]||0));
    let universo = [...nucleo80, ...restantes.slice(0, 5)];

    let resultadosFinales = [];
    let i = 0;
    while(resultadosFinales.length < cant && i < 5000) {
        let combinacion = [...universo].sort(() => 0.5 - Math.random()).slice(0, 50).sort((a,b)=>a-b);
        if(validarFiltros(combinacion)) resultadosFinales.push(combinacion);
        i++;
    }

    panel.innerHTML = "";
    resultadosFinales.forEach((jg, idx) => {
        // Crear Jugada Espejo (Los 50 nÃºmeros que NO estÃ¡n en la jugada original)
        let espejo = [];
        for(let n=0; n<100; n++) {
            let s = n.toString().padStart(2,"0");
            if(!jg.includes(s)) espejo.push(s);
        }

        let html = `
            <div class="game-box">
                <strong>Juego Principal ${idx+1}</strong>
                <div class="num-grid">${jg.map(n => <span class="n">${n}</span>).join("")}</div>
            </div>
            <div class="game-box mirror-box">
                <span class="label-espejo">ðŸ”„ Jugada Espejo (Altamente recomendada)</span>
                <div class="num-grid">${espejo.sort((a,b)=>a-b).map(n => <span class="n">${n}</span>).join("")}</div>
            </div>
        `;
        panel.innerHTML += html;
    });
}
</script>
</body>
</html>
