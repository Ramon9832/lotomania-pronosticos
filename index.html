<script>
const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5zTmvIQ_c4bX9ADf1JzSKvivksl2Mkejdu9cvwrSwjvqB1_f2xSBudShflElF0CBMsJ260c_Beodx/pub?gid=0&single=true&output=csv";

let freq = {};
let porDecena = Array.from({length:10},()=>[]);

async function cargar(){
  freq={};
  porDecena = Array.from({length:10},()=>[]);

  let r = await fetch(CSV);
  let t = await r.text();
  let rows = t.trim().split("\n");

  document.getElementById("total").textContent = rows.length;
  document.getElementById("fecha").textContent = rows[0].split(",")[1] || "—";

  rows.forEach(l=>{
    let c=l.split(",");
    if(!c[2]) return;

    c[2].split(" ").forEach(n=>{
      n=n.padStart(2,"0");
      freq[n]=(freq[n]||0)+1;
      let d=Math.floor(parseInt(n)/10);
      if(!porDecena[d].includes(n)) porDecena[d].push(n);
    });
  });

  // quedarse con los últimos 8 de cada decena
  porDecena = porDecena.map(d => d.slice(-8));
}

function obtenerTop50(){
  let base=[];

  // 8 por decena = 80 candidatos
  porDecena.forEach(d => base.push(...d));

  // ordenar por frecuencia
  base.sort((a,b)=>(freq[b]||0)-(freq[a]||0));

  // asegurar 50 exactos
  return base.slice(0,50);
}

function generarJugadas(base, cantidad){
  let usadas=new Set();
  let jugadas=[];

  while(jugadas.length<cantidad){
    let mix=[...base].sort(()=>Math.random()-0.5).slice(0,50);
    let key=mix.join("-");
    if(!usadas.has(key)){
      usadas.add(key);
      jugadas.push(mix);
    }
  }
  return jugadas;
}

async function generar(){
  await cargar();

  let top50 = obtenerTop50();

  let top=document.getElementById("top50");
  top.innerHTML="";
  top50.forEach(n=>{
    let d=document.createElement("div");
    d.className="num";
    d.textContent=n;
    top.appendChild(d);
  });

  let cant=parseInt(document.getElementById("cantidad").value);
  let jugadas=generarJugadas(top50,cant);

  let j=document.getElementById("jugadas");
  j.innerHTML="";
  jugadas.forEach((g,i)=>{
    let div=document.createElement("div");
    div.className="game";
    div.textContent="Jugada "+(i+1)+": "+g.join(", ");
    j.appendChild(div);
  });
}

generar();
</script>
