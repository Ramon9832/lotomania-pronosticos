<script>
const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5zTmvIQ_c4bX9ADf1JzSKvivksl2Mkejdu9cvwrSwjvqB1_f2xSBudShflElF0CBMsJ260c_Beodx/pub?gid=0&single=true&output=csv";

let sorteos=[];
let freq={};
let peso={};

async function cargar(){
  sorteos=[];
  freq={};
  peso={};

  let r=await fetch(CSV);
  let t=await r.text();
  let rows=t.trim().split("\n");

  document.getElementById("total").textContent=rows.length;
  document.getElementById("fecha").textContent=rows[0].split(",")[1];

  rows.forEach((l,i)=>{
    let c=l.split(",");
    if(!c[2]) return;

    let nums=c[2].trim().split(/\s+/);
    sorteos.push(nums);

    let factor = rows.length - i; // recencia

    nums.forEach(n=>{
      n=n.padStart(2,"0");
      freq[n]=(freq[n]||0)+1;
      peso[n]=(peso[n]||0)+factor;
    });
  });
}

// üîπ √∫ltimos 8 por decena
function ultimos8PorDecena(){
  let dec=[...Array(10)].map(()=>[]);
  for(let s of sorteos){
    s.forEach(n=>{
      let d=Math.floor(n/10);
      if(!dec[d].includes(n) && dec[d].length<8){
        dec[d].push(n);
      }
    });
    if(dec.every(x=>x.length===8)) break;
  }
  return dec.flat();
}

// üîπ top ponderados
function topPonderados(n=20){
  return Object.keys(peso)
    .sort((a,b)=>(peso[b]/freq[b])-(peso[a]/freq[a]))
    .slice(0,n);
}

// üîπ armar base de 50
function base50(){
  let base=new Set();

  // 1Ô∏è‚É£ √∫ltimos 8 por decena ‚Üí 80 posibles
  let u8=ultimos8PorDecena();
  u8.forEach(n=>{
    if(base.size<40) base.add(n);
  });

  // 2Ô∏è‚É£ al menos 5 top fuertes
  let top=topPonderados(20);
  top.slice(0,5).forEach(n=>base.add(n));

  // 3Ô∏è‚É£ completar con top restantes
  for(let n of top){
    if(base.size<50) base.add(n);
  }

  // 4Ô∏è‚É£ ajuste final
  let i=0;
  while(base.size<50 && i<100){
    base.add(String(i).padStart(2,"0"));
    i++;
  }

  return [...base].slice(0,50);
}

// üîπ generar jugadas √∫nicas
async function generar(){
  await cargar();

  let base=base50();

  let top50=document.getElementById("top50");
  top50.innerHTML="";
  base.forEach(n=>{
    let d=document.createElement("div");
    d.className="num";
    d.textContent=n;
    top50.appendChild(d);
  });

  let cant=parseInt(document.getElementById("cantidad").value);
  let cont=document.getElementById("jugadas");
  cont.innerHTML="";

  let firmas=new Set();

  for(let i=1;i<=cant;i++){
    let jugada;
    let intentos=0;

    do{
      jugada=[...base]
        .sort(()=>0.5-Math.random())
        .map((n,idx)=>idx%7===0 ? topPonderados(20)[idx%20] : n)
        .slice(0,50)
        .sort();

      intentos++;
    }while(firmas.has(jugada.join("-")) && intentos<20);

    firmas.add(jugada.join("-"));

    let g=document.createElement("div");
    g.className="game";
    g.textContent="Jugada "+i+": "+jugada.join(", ");
    cont.appendChild(g);
  }
}

generar();
</script>
